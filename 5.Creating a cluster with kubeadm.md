
# ğŸ“˜ Summary: Creating a Kubernetes Cluster with `kubeadm`

## ğŸ§° What is `kubeadm`?
- A tool to **easily set up** a minimum viable Kubernetes cluster.
- Follows **best practices** and passes **Kubernetes Conformance tests**.
- Supports:
  - Cluster creation
  - Cluster upgrade
  - Bootstrap tokens (used for securely adding nodes)

### âœ… Use kubeadm if:
- You're **trying out Kubernetes** for the first time.
- You're an **experienced user automating** cluster setups.
- You're building **installers or automation tools** (e.g., Ansible, Terraform).

## ğŸ’» Requirements (Before you start)
- OS: Linux with deb/rpm support (Ubuntu, CentOS).
- RAM: Minimum **2 GiB** per machine.
- CPU: At least **2 CPUs** for control-plane.
- **Full network connectivity** between all nodes.
- Use a `kubeadm` version compatible with your desired Kubernetes version.
- Networking tools such as `ip route` must work on hosts.

> ğŸ“ Example: To check default gateway IP  
```bash
ip route show  # Look for 'default via'
```

## ğŸ§± Cluster Setup Steps

### 1. Prepare the Hosts
Install:
- **Container runtime** (e.g., containerd, Docker)
- **kubeadm**, **kubelet**, **kubectl**

ğŸ“Œ *Use `kubeadm` install guide for this.*  
ğŸ”„ If upgrading, kubelet will crash-loop until kubeadm is re-initialized. This is **expected**.

---

### 2. Network Setup
- `kubeadm` automatically finds IPs using default gateway.
- You can set **custom IPs** using:
  - `--apiserver-advertise-address` (for API Server)
  - `--node-ip` (for kubelet)
- Don't change IPs later unless you re-issue certificates.

ğŸ“Œ Example for API server:
```bash
kubeadm init --apiserver-advertise-address=192.168.1.100
```

ğŸ”´ *Avoid custom IP setups.* Itâ€™s better to configure the host network so components can auto-detect IPs.

---

### 3. Pre-Pull Images (Offline Setup)
If no internet:
- Use `kubeadm config images pull` to download needed images.
- You can also configure **custom image repositories**.

---

### 4. Initialize the Control Plane

ğŸ”§ Run:
```bash
kubeadm init --control-plane-endpoint=<DNS/IP> --pod-network-cidr=<CIDR>
```

Example:
```bash
kubeadm init \
  --control-plane-endpoint=cluster-endpoint \
  --pod-network-cidr=192.168.0.0/16
```

ğŸ›  Flags:
- `--control-plane-endpoint`: Shared DNS/IP for future HA clusters
- `--pod-network-cidr`: Needed by some network plugins (e.g., Calico, Flannel)
- `--cri-socket`: Use if multiple container runtimes are present

---

## ğŸ›  After kubeadm init

### âš™ Setup `kubectl` for current user:
```bash
mkdir -p $HOME/.kube
sudo cp /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

OR for root user:
```bash
export KUBECONFIG=/etc/kubernetes/admin.conf
```

ğŸš¨ Do not share:
- `admin.conf` â†’ grants `cluster-admin` rights
- `super-admin.conf` â†’ full access, bypasses RBAC!

---

## ğŸ” `kubeadm join` (Add Worker Nodes)

Example:
```bash
kubeadm join <control-plane-host>:<port> \
  --token <token> \
  --discovery-token-ca-cert-hash sha256:<hash>
```

ğŸ’¡ Save this command!  
Tokens are secret and allow nodes to join securely.  
Manage with:
```bash
kubeadm token list
kubeadm token create
kubeadm token delete
```

---

## ğŸŒ Installing Pod Network Add-on (CNI)

Before pods can communicate:
- You **must install a CNI plugin** (e.g., Calico, Flannel, Weave).
- Without a network plugin, **CoreDNS won't work**.

Example for Flannel:
```bash
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```

ğŸ“ View all options:  
https://kubernetes.io/docs/concepts/cluster-administration/networking/

---

## ğŸ§  Important Notes & Tips

- HA Cluster? Always use `--control-plane-endpoint`.
- Cluster components (e.g., kube-apiserver, etcd) are initialized and configured.
- `kubeadm init` performs prechecks, installs components, and may take a few minutes.
- If re-running `kubeadm init`, **tear down the existing cluster** first.
- For different architectures, ensure your images support them in DaemonSets.

---

## ğŸ“š More Resources
- [kubeadm Reference Guide](https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/)
- [kubeadm Config File](https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/)
- [Pod Network Plugins](https://kubernetes.io/docs/concepts/cluster-administration/networking/)

---

