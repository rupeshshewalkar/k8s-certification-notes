
# 🧊 Kubernetes Container Images – Complete Summary

## 📌 What is a Container Image?
- A **container image** is a **bundle of executable software**, which includes:
  - The **application code**
  - All its **dependencies** (libraries, binaries, etc.)
- Images are **self-contained** and assume a specific **runtime environment**.
- They can be run as-is on a container runtime.

### 🔧 Example
If you have a Node.js app, the image might include:
```bash
FROM node:18
COPY . /app
RUN npm install
CMD ["node", "index.js"]
```

---

## 📤 Creating and Using Container Images
- Usually, you:
  1. **Build** your app's image.
  2. **Push** it to a container registry (e.g., DockerHub, registry.k8s.io).
  3. **Reference** it in Kubernetes (e.g., inside a Pod manifest).

---

## 🏷️ Image Naming Conventions
Container image names can include:
```
[registry[:port]/]repository/image[:tag][@digest]
```

### 📌 Examples:
| Image Reference | Explanation |
|-----------------|-------------|
| `busybox` | No registry or tag → default to DockerHub and `latest` tag. |
| `busybox:1.32.0` | Specifies tag version `1.32.0`. |
| `registry.k8s.io/pause:latest` | Custom registry with latest tag. |
| `registry.k8s.io/pause@sha256:<digest>` | Uses a specific image digest. |
| `registry.k8s.io/pause:3.5@sha256:<digest>` | Has tag and digest. Only **digest** is used for pulling. |

### 🛑 Note:
- If **no registry is mentioned**, Kubernetes assumes DockerHub.
- If **no tag is mentioned**, `latest` is assumed.

---

## 🔖 Tags vs 🧬 Digests

| Aspect     | Tag            | Digest (Immutable) |
|------------|----------------|---------------------|
| Type       | Named version  | Hash (e.g., SHA256) |
| Mutable?   | Yes (can point to different images) | No |
| Example    | `myapp:v1.2.3` | `myapp@sha256:abcd...` |

✅ **Use Digests in production** for repeatable deployments.

---

## 🎯 OCI Naming Rules
- Tags must match:  
  `[a-zA-Z0-9_][a-zA-Z0-9._-]{0,127}`
- Max 128 characters

---

## 📦 Image Pull Policies

### `imagePullPolicy` values:
| Value         | Behavior |
|---------------|----------|
| `IfNotPresent` | Pulls image **only if not present locally**. *(Default for specific tags)* |
| `Always`       | Always tries pulling image from registry. *(Default for `latest` or no tag)* |
| `Never`        | Never pulls image. Will fail if image not found locally. |

### 🛑 Important:
- `Always` is useful for **dev/testing**, but **avoid `latest` in production** as it:
  - Makes rollbacks difficult
  - Causes unpredictability (due to mutable tag)

---

## 🧩 Pull Policy Defaults

When `imagePullPolicy` is omitted:
| Image Format | imagePullPolicy |
|--------------|-----------------|
| Includes digest | `IfNotPresent` |
| Includes `:latest` | `Always` |
| No tag | `Always` |
| Specific tag (not `latest`) | `IfNotPresent` |

🔁 This policy is set **only during initial object creation**. If you later change the image, **you must manually update** the pull policy if needed.

---

## 🔁 Forcing Image Pulls

Ways to ensure image always pulled:
1. Set `imagePullPolicy: Always`
2. Use `:latest` tag with no `imagePullPolicy`
3. Use **no tag** (defaults to latest)
4. Enable the **AlwaysPullImages** admission controller

---

## ❗ ImagePullBackOff Error

- **Meaning**: Image failed to pull
- **Common causes**:
  - Invalid image name
  - Private registry without `imagePullSecrets`
- **BackOff** means Kubernetes retries pulling with increasing delays (up to 5 mins)

---

## 🎭 Pulls Based on Runtime Class (Alpha feature)

- Introduced in **K8s v1.29 (Alpha)**.
- Allows image pulling based on `(image, runtime handler)` tuple.
- Useful for VM-based containers like **Windows Hyper-V**.

---

## 🔄 Serial vs 🔀 Parallel Image Pulls

### 🔂 Default Behavior
- `kubelet` pulls images **one at a time (serial)** per node.

### 🔄 Enable Parallel Pulls
- Set `serializeImagePulls: false` in kubelet config
- Allows multiple image pulls **simultaneously**
- Each Pod's containers are **still pulled serially**, but different Pods on the same node can pull in parallel.

> ✅ Ensure the container runtime supports parallel pulls.

---

## 🔢 Limit Max Parallel Pulls (Beta in v1.32)

- Use `maxParallelImagePulls: n` in kubelet config
- Only **n images** pulled at once; others wait
- Helps **control bandwidth or disk usage**
- If `maxParallelImagePulls >= 2`, must also set `serializeImagePulls: false`

---

## 📦 Multi-Architecture Images (Image Indexes)

> A **container registry** can serve **multi-architecture images** using **OCI Image Indexes**, which allow:
- Different binaries (e.g., ARM, x86) under one logical image tag
- Runtime automatically pulls the correct image for node’s architecture

---

## 📚 Summary Tips for Exam

- ✅ Use **image digests** for consistency in production.
- ❌ Avoid using `:latest` tag in critical deployments.
- 🧩 Default `imagePullPolicy` depends on tag/digest usage.
- 🔁 Always update `imagePullPolicy` manually if the tag changes post-deployment.
- 🚫 `ImagePullBackOff` = pulling failed → check image name, registry access, secrets.
- 🔀 Parallel image pulling is opt-in (`serializeImagePulls: false`).
- 🛡️ Use admission controllers to enforce image digest usage.

